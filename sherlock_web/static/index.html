<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sherlock Web - Username OSINT</title>
<style>
  :root {
    --bg-primary: #0a0e17;
    --bg-secondary: #111827;
    --bg-card: #1a2332;
    --bg-hover: #243044;
    --border: #2d3748;
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent: #22d3ee;
    --accent-dim: #0e7490;
    --green: #22c55e;
    --green-dim: rgba(34,197,94,0.15);
    --red: #ef4444;
    --red-dim: rgba(239,68,68,0.15);
    --yellow: #eab308;
    --yellow-dim: rgba(234,179,8,0.15);
    --purple: #a855f7;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', -apple-system, system-ui, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
  }

  .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

  /* Header */
  header {
    border-bottom: 1px solid var(--border);
    padding: 20px 0;
    background: linear-gradient(180deg, #0f1729 0%, var(--bg-primary) 100%);
  }
  header .container { display: flex; align-items: center; justify-content: space-between; }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo svg { width: 36px; height: 36px; }
  .logo h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
  .logo h1 span { color: var(--accent); }
  .logo .subtitle { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; }
  .header-stats { display: flex; gap: 24px; }
  .header-stat { text-align: center; }
  .header-stat .value { font-size: 20px; font-weight: 700; color: var(--accent); }
  .header-stat .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

  /* Search Section */
  .search-section {
    padding: 40px 0 32px;
  }
  .search-box {
    display: flex;
    gap: 12px;
    max-width: 800px;
    margin: 0 auto;
  }
  .search-input-wrapper {
    flex: 1;
    position: relative;
  }
  .search-input-wrapper svg {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--text-muted);
  }
  .search-input {
    width: 100%;
    padding: 14px 16px 14px 48px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text-muted); }

  .btn {
    padding: 14px 28px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary {
    background: var(--accent);
    color: var(--bg-primary);
  }
  .btn-primary:hover { background: #06b6d4; transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--bg-hover); }
  .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 8px; }

  /* Options bar */
  .search-options {
    display: flex;
    gap: 16px;
    max-width: 800px;
    margin: 12px auto 0;
    align-items: center;
  }
  .option-group { display: flex; align-items: center; gap: 6px; }
  .option-group label { font-size: 13px; color: var(--text-secondary); cursor: pointer; }
  .option-group input[type="number"] {
    width: 60px;
    padding: 6px 8px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 13px;
  }
  .option-group input[type="checkbox"] {
    accent-color: var(--accent);
    width: 16px;
    height: 16px;
  }

  /* Status Bar */
  .status-bar {
    padding: 16px 0;
    display: none;
  }
  .status-bar.active { display: block; }
  .status-inner {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .status-left { display: flex; align-items: center; gap: 16px; }
  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .status-text { font-size: 14px; color: var(--text-secondary); }
  .status-text strong { color: var(--text-primary); }
  .progress-bar {
    flex: 1;
    max-width: 300px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 24px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0;
  }
  .status-counters { display: flex; gap: 16px; }
  .counter {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 600;
  }
  .counter .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  .counter.found .dot { background: var(--green); }
  .counter.notfound .dot { background: var(--text-muted); }
  .counter.error .dot { background: var(--yellow); }

  /* Main content */
  .main-content {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
    padding-bottom: 48px;
  }

  /* Results panel */
  .results-panel { min-height: 400px; }
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .panel-title { font-size: 16px; font-weight: 600; }
  .panel-actions { display: flex; gap: 8px; }

  /* Filter bar */
  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-secondary);
    transition: all 0.2s;
  }
  .filter-chip:hover { border-color: var(--accent); }
  .filter-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

  .filter-input {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    outline: none;
    width: 180px;
  }
  .filter-input:focus { border-color: var(--accent); }

  /* Results grid */
  .results-grid {
    display: grid;
    gap: 8px;
  }
  .result-card {
    display: grid;
    grid-template-columns: 32px 1fr auto auto;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    transition: all 0.15s;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  .result-card:hover { background: var(--bg-hover); border-color: var(--accent-dim); }
  .result-card.claimed { border-left: 3px solid var(--green); }
  .result-card.available { opacity: 0.5; }
  .result-card.unknown { border-left: 3px solid var(--yellow); }
  .result-card.waf { border-left: 3px solid var(--red); }

  .result-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
  }
  .result-icon.claimed { background: var(--green-dim); color: var(--green); }
  .result-icon.available { background: var(--bg-hover); color: var(--text-muted); }
  .result-icon.unknown { background: var(--yellow-dim); color: var(--yellow); }
  .result-icon.waf { background: var(--red-dim); color: var(--red); }

  .result-info h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 2px;
  }
  .result-info h4 a {
    color: var(--text-primary);
    text-decoration: none;
  }
  .result-info h4 a:hover { color: var(--accent); }
  .result-info .url {
    font-size: 12px;
    color: var(--text-muted);
    word-break: break-all;
  }
  .result-info .url a { color: var(--text-muted); text-decoration: none; }
  .result-info .url a:hover { color: var(--accent); text-decoration: underline; }

  .result-time { font-size: 12px; color: var(--text-muted); white-space: nowrap; }
  .result-status {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .result-status.CLAIMED { background: var(--green-dim); color: var(--green); }
  .result-status.AVAILABLE { background: var(--bg-hover); color: var(--text-muted); }
  .result-status.UNKNOWN { background: var(--yellow-dim); color: var(--yellow); }
  .result-status.WAF { background: var(--red-dim); color: var(--red); }
  .result-status.ILLEGAL { background: var(--bg-hover); color: var(--text-muted); }

  /* Sidebar */
  .sidebar {}
  .sidebar-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .sidebar-card h3 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* History list */
  .history-list { display: grid; gap: 8px; }
  .history-item {
    padding: 10px 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .history-item:hover { background: var(--bg-hover); }
  .history-item .username { font-weight: 600; font-size: 14px; }
  .history-item .meta {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-muted);
  }
  .history-item .found-badge {
    color: var(--green);
    font-weight: 600;
  }

  /* Stats summary */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .stat-box {
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    text-align: center;
  }
  .stat-box .num { font-size: 24px; font-weight: 700; }
  .stat-box .num.green { color: var(--green); }
  .stat-box .num.cyan { color: var(--accent); }
  .stat-box .num.yellow { color: var(--yellow); }
  .stat-box .num.muted { color: var(--text-muted); }
  .stat-box .lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-muted);
  }
  .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-secondary); }
  .empty-state p { font-size: 14px; }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { border-color: var(--red); color: var(--red); }
  .toast.success { border-color: var(--green); color: var(--green); }

  /* Responsive */
  @media (max-width: 900px) {
    .main-content { grid-template-columns: 1fr; }
    .header-stats { display: none; }
    .result-card { grid-template-columns: 28px 1fr auto; }
    .result-time { display: none; }
  }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="logo">
      <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="15" cy="15" r="10" stroke="currentColor" stroke-width="2.5" fill="none" style="color: var(--accent)"/>
        <line x1="22" y1="22" x2="33" y2="33" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="color: var(--accent)"/>
        <circle cx="15" cy="15" r="4" fill="var(--accent)" opacity="0.3"/>
      </svg>
      <div>
        <h1>Sherlock <span>Web</span></h1>
        <div class="subtitle">Username OSINT Intelligence</div>
      </div>
    </div>
    <div class="header-stats">
      <div class="header-stat">
        <div class="value" id="totalSites">-</div>
        <div class="label">Sites</div>
      </div>
      <div class="header-stat">
        <div class="value" id="totalSearches">-</div>
        <div class="label">Searches</div>
      </div>
    </div>
  </div>
</header>

<section class="search-section">
  <div class="container">
    <div class="search-box">
      <div class="search-input-wrapper">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" class="search-input" id="usernameInput" placeholder="Enter username to investigate..." autofocus>
      </div>
      <button class="btn btn-primary" id="searchBtn" onclick="startSearch()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        Hunt
      </button>
    </div>
    <div class="search-options">
      <div class="option-group">
        <label for="timeoutInput">Timeout (s):</label>
        <input type="number" id="timeoutInput" value="60" min="5" max="300">
      </div>
      <div class="option-group">
        <input type="checkbox" id="nsfwCheck">
        <label for="nsfwCheck">Include NSFW sites</label>
      </div>
    </div>
  </div>
</section>

<section class="status-bar" id="statusBar">
  <div class="container">
    <div class="status-inner">
      <div class="status-left">
        <div class="spinner" id="statusSpinner"></div>
        <div class="status-text" id="statusText">Searching...</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="status-counters">
        <div class="counter found"><div class="dot"></div><span id="foundCount">0</span> Found</div>
        <div class="counter notfound"><div class="dot"></div><span id="checkedCount">0</span> Checked</div>
        <div class="counter error"><div class="dot"></div><span id="errorCount">0</span> Errors</div>
      </div>
    </div>
  </div>
</section>

<section class="container">
  <div class="main-content">
    <div class="results-panel">
      <div class="panel-header">
        <div class="panel-title" id="resultsTitle">Results</div>
        <div class="panel-actions" id="exportActions" style="display:none">
          <button class="btn btn-secondary btn-sm" onclick="exportCSV()">Export CSV</button>
          <button class="btn btn-secondary btn-sm" onclick="exportJSON()">Export JSON</button>
          <button class="btn btn-secondary btn-sm" onclick="copyFoundURLs()">Copy URLs</button>
        </div>
      </div>
      <div class="filter-bar" id="filterBar" style="display:none">
        <div class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">All</div>
        <div class="filter-chip" data-filter="CLAIMED" onclick="setFilter('CLAIMED', this)">Found</div>
        <div class="filter-chip" data-filter="AVAILABLE" onclick="setFilter('AVAILABLE', this)">Not Found</div>
        <div class="filter-chip" data-filter="UNKNOWN" onclick="setFilter('UNKNOWN', this)">Errors</div>
        <input type="text" class="filter-input" placeholder="Filter by site name..." oninput="filterBySite(this.value)">
      </div>
      <div class="results-grid" id="resultsGrid">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <h3>Ready to Investigate</h3>
          <p>Enter a username above to search across 400+ social networks</p>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-card" id="statsCard" style="display:none">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2">
            <path d="M18 20V10M12 20V4M6 20v-6"/>
          </svg>
          Search Stats
        </h3>
        <div class="stats-grid">
          <div class="stat-box"><div class="num green" id="statFound">0</div><div class="lbl">Found</div></div>
          <div class="stat-box"><div class="num cyan" id="statTotal">0</div><div class="lbl">Checked</div></div>
          <div class="stat-box"><div class="num yellow" id="statErrors">0</div><div class="lbl">Errors</div></div>
          <div class="stat-box"><div class="num muted" id="statTime">0s</div><div class="lbl">Duration</div></div>
        </div>
      </div>

      <div class="sidebar-card">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2">
            <path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
          </svg>
          Recent Searches
        </h3>
        <div class="history-list" id="historyList">
          <div style="color: var(--text-muted); font-size: 13px;">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="toast" id="toast"></div>

<script>
  let ws = null;
  let currentSearchId = null;
  let allResults = [];
  let currentFilter = 'all';
  let siteFilterText = '';
  let searchStartTime = null;
  let totalSitesCount = 0;

  // Load initial data
  async function init() {
    try {
      const [sitesRes, historyRes] = await Promise.all([
        fetch('/api/sites'),
        fetch('/api/history?limit=20'),
      ]);
      const sites = await sitesRes.json();
      const history = await historyRes.json();

      document.getElementById('totalSites').textContent = sites.count;
      totalSitesCount = sites.count;
      document.getElementById('totalSearches').textContent = history.length;
      renderHistory(history);
    } catch (e) {
      console.error('Init error:', e);
    }
  }

  function renderHistory(history) {
    const list = document.getElementById('historyList');
    if (!history.length) {
      list.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No searches yet</div>';
      return;
    }
    list.innerHTML = history.map(h => `
      <div class="history-item" onclick="loadSearch(${h.id})">
        <div class="username">@${escapeHtml(h.username)}</div>
        <div class="meta">
          <span>${timeAgo(h.started_at)}</span>
          <span class="found-badge">${h.found_count} found</span>
        </div>
      </div>
    `).join('');
  }

  function startSearch() {
    const username = document.getElementById('usernameInput').value.trim();
    if (!username) return;

    const timeout = parseInt(document.getElementById('timeoutInput').value) || 60;
    const nsfw = document.getElementById('nsfwCheck').checked;

    // Reset state
    allResults = [];
    currentFilter = 'all';
    siteFilterText = '';
    searchStartTime = Date.now();

    document.getElementById('resultsGrid').innerHTML = '';
    document.getElementById('statusBar').classList.add('active');
    document.getElementById('filterBar').style.display = 'flex';
    document.getElementById('statsCard').style.display = 'block';
    document.getElementById('exportActions').style.display = 'none';
    document.getElementById('statusSpinner').style.display = 'block';
    document.getElementById('searchBtn').disabled = true;
    document.getElementById('progressFill').style.width = '0';
    updateCounters(0, 0, 0);
    updateStats(0, 0, 0);

    // WebSocket
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws/search`);

    ws.onopen = () => {
      ws.send(JSON.stringify({ username, timeout, nsfw }));
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'started') {
        currentSearchId = data.search_id;
        document.getElementById('resultsTitle').textContent = `Results for @${data.username}`;
        document.getElementById('statusText').innerHTML = `Scanning <strong>@${escapeHtml(data.username)}</strong> across ${totalSitesCount}+ sites...`;
      }
      else if (data.type === 'result') {
        allResults.push(data);
        addResultCard(data);
        updateCountersFromResults();

        const progress = (allResults.length / totalSitesCount) * 100;
        document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
      }
      else if (data.type === 'done') {
        finishSearch();
      }
      else if (data.type === 'error') {
        showToast(data.message, 'error');
        finishSearch();
      }
    };

    ws.onerror = () => {
      showToast('WebSocket connection error', 'error');
      finishSearch();
    };

    ws.onclose = () => {
      finishSearch();
    };
  }

  function finishSearch() {
    document.getElementById('statusSpinner').style.display = 'none';
    document.getElementById('searchBtn').disabled = false;
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('exportActions').style.display = 'flex';

    const duration = ((Date.now() - searchStartTime) / 1000).toFixed(1);
    const found = allResults.filter(r => r.status === 'CLAIMED').length;
    document.getElementById('statusText').innerHTML = `Complete &mdash; <strong>${found}</strong> profiles found in <strong>${duration}s</strong>`;
    document.getElementById('statTime').textContent = duration + 's';

    // Refresh history
    fetch('/api/history?limit=20').then(r => r.json()).then(renderHistory);

    ws = null;
  }

  function addResultCard(data) {
    if (!shouldShow(data)) return;

    const grid = document.getElementById('resultsGrid');
    const emptyState = grid.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    const statusClass = data.status.toLowerCase();
    const icon = data.status === 'CLAIMED' ? '&#10003;' :
                 data.status === 'WAF' ? '&#9888;' :
                 data.status === 'UNKNOWN' ? '?' : '&times;';
    const timeStr = data.response_time_ms ? `${data.response_time_ms}ms` : '';
    const url = data.url_user || '#';

    const card = document.createElement('div');
    card.className = `result-card ${statusClass}`;
    card.dataset.status = data.status;
    card.dataset.site = data.site_name.toLowerCase();
    card.innerHTML = `
      <div class="result-icon ${statusClass}">${icon}</div>
      <div class="result-info">
        <h4><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(data.site_name)}</a></h4>
        <div class="url"><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a></div>
      </div>
      <div class="result-time">${timeStr}</div>
      <div class="result-status ${data.status}">${data.status}</div>
    `;

    // Insert found results at the top
    if (data.status === 'CLAIMED') {
      grid.insertBefore(card, grid.firstChild);
    } else {
      grid.appendChild(card);
    }
  }

  function shouldShow(data) {
    if (currentFilter !== 'all' && data.status !== currentFilter) return false;
    if (siteFilterText && !data.site_name.toLowerCase().includes(siteFilterText)) return false;
    return true;
  }

  function setFilter(filter, el) {
    currentFilter = filter;
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    rerenderResults();
  }

  function filterBySite(text) {
    siteFilterText = text.toLowerCase();
    rerenderResults();
  }

  function rerenderResults() {
    const grid = document.getElementById('resultsGrid');
    grid.innerHTML = '';
    const filtered = allResults.filter(shouldShow);
    // Sort: CLAIMED first, then by site name
    filtered.sort((a, b) => {
      if (a.status === 'CLAIMED' && b.status !== 'CLAIMED') return -1;
      if (b.status === 'CLAIMED' && a.status !== 'CLAIMED') return 1;
      return a.site_name.localeCompare(b.site_name);
    });
    filtered.forEach(data => addResultCard(data));
    if (!filtered.length) {
      grid.innerHTML = '<div style="color: var(--text-muted); padding: 40px; text-align: center;">No results match filter</div>';
    }
  }

  function updateCountersFromResults() {
    const found = allResults.filter(r => r.status === 'CLAIMED').length;
    const errors = allResults.filter(r => r.status === 'UNKNOWN' || r.status === 'WAF').length;
    updateCounters(found, allResults.length, errors);
    updateStats(found, allResults.length, errors);
  }

  function updateCounters(found, checked, errors) {
    document.getElementById('foundCount').textContent = found;
    document.getElementById('checkedCount').textContent = checked;
    document.getElementById('errorCount').textContent = errors;
  }

  function updateStats(found, total, errors) {
    document.getElementById('statFound').textContent = found;
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statErrors').textContent = errors;
    if (searchStartTime) {
      document.getElementById('statTime').textContent = ((Date.now() - searchStartTime) / 1000).toFixed(0) + 's';
    }
  }

  async function loadSearch(searchId) {
    try {
      const res = await fetch(`/api/search/${searchId}`);
      const data = await res.json();

      allResults = data.results.map(r => ({
        site_name: r.site_name,
        url_user: r.url_user,
        status: r.status,
        http_status: r.http_status,
        response_time_ms: r.response_time_ms,
      }));

      currentSearchId = searchId;
      currentFilter = 'all';
      siteFilterText = '';

      document.getElementById('resultsTitle').textContent = `Results for @${data.username}`;
      document.getElementById('filterBar').style.display = 'flex';
      document.getElementById('statsCard').style.display = 'block';
      document.getElementById('exportActions').style.display = 'flex';
      document.getElementById('statusBar').classList.remove('active');

      updateCounters(data.found_count, data.total_sites, data.error_count);
      updateStats(data.found_count, data.total_sites, data.error_count);
      document.getElementById('statTime').textContent = '-';

      // Reset filter chips
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');

      rerenderResults();
    } catch (e) {
      showToast('Failed to load search', 'error');
    }
  }

  async function exportCSV() {
    if (!currentSearchId) return;
    window.open(`/api/search/${currentSearchId}/export/csv`, '_blank');
  }

  async function exportJSON() {
    if (!currentSearchId) return;
    window.open(`/api/search/${currentSearchId}/export/json`, '_blank');
  }

  function copyFoundURLs() {
    const urls = allResults.filter(r => r.status === 'CLAIMED').map(r => r.url_user).join('\n');
    navigator.clipboard.writeText(urls).then(() => {
      showToast('URLs copied to clipboard', 'success');
    });
  }

  function showToast(msg, type = '') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast show ' + type;
    setTimeout(() => { toast.className = 'toast'; }, 3000);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  }

  // Enter key to search
  document.getElementById('usernameInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') startSearch();
  });

  init();
</script>
<footer style="text-align:center;padding:16px 0;margin-top:32px;border-top:1px solid var(--border);color:var(--text-muted);font-size:13px;">
  Developed by <a href="https://kccsonline.com" target="_blank" style="color:var(--text-secondary);text-decoration:none;">KCCS</a> &bull; <a href="https://kccsonline.com" target="_blank" style="color:var(--text-muted);text-decoration:none;">kccsonline.com</a>
</footer>
</body>
</html>
